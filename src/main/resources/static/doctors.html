<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Doctors — Hospital Management</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body class="doctors">
    <div class="container">
      <header class="header">
        <h1 class="title">Doctor Management</h1>
        <div style="display: flex; gap: 10px">
          <a class="home-btn" href="index.html">Home</a>
          <button class="btn" id="logoutBtn">Logout</button>
        </div>
      </header>

      <!-- Directory -->
      <section class="card">
        <div class="card__header">
          <h2 class="card__title">Directory</h2>

          <div class="search">
            <input
              id="searchInput"
              class="input"
              placeholder="Search by name or specialization"
            />
            <select id="filterStatus" class="select">
              <option value="">Status</option>
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
            </select>
            <button id="btnSearch" class="btn">Search</button>
          </div>
        </div>

        <div class="card__body">
          <div class="table-wrap">
            <table id="doctorsTable">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Specialization</th>
                  <th>Qualification</th>
                  <th>Experience</th>
                  <th>Phone</th>
                  <th>Email</th>
                  <th>Status</th>
                  <th style="text-align: center">Actions</th>
                </tr>
              </thead>
              <tbody id="doctorsTbody"></tbody>
            </table>
          </div>
          <p class="muted">Loaded from GET <code>/api/doctors</code>.</p>
        </div>
      </section>

      <!-- Add / Edit -->
      <aside class="card">
        <div class="card__header">
          <h2 class="card__title">Add / Edit Doctor</h2>
        </div>
        <div class="card__body">
          <form id="doctorForm" class="grid">
            <input id="editingId" type="hidden" />

            <label class="label">
              Full Name
              <input id="doctorName" class="input" required />
            </label>

            <div class="two-col">
              <label class="label">
                Specialization
                <select id="specialization" class="select" required>
                  <option value="">Select specialization</option>
                  <option>General Medicine</option>
                  <option>Cardiology</option>
                  <option>Neurology</option>
                  <option>Orthopedics</option>
                </select>
              </label>

              <label class="label">
                Qualification
                <input
                  id="qualification"
                  class="input"
                  placeholder="MBBS, MD, etc."
                />
              </label>
            </div>

            <div class="two-col">
              <label class="label">
                Gender
                <select id="gender" class="select">
                  <option value="">Select gender</option>
                  <option>Male</option>
                  <option>Female</option>
                  <option>Other</option>
                </select>
              </label>

              <label class="label">
                Experience
                <input
                  id="experience"
                  class="input"
                  placeholder="e.g. 5 years"
                />
              </label>
            </div>

            <div class="two-col">
              <label class="label">
                Phone
                <input id="phoneNumber" class="input" placeholder="+91..." />
              </label>
              <label class="label">
                Email
                <input id="email" class="input" type="email" />
              </label>
            </div>

            <label class="label">
              Address
              <textarea
                id="address"
                class="textarea"
                placeholder="Clinic or hospital address"
              ></textarea>
            </label>

            <label class="label">
              Status
              <select id="status" class="select">
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
              </select>
            </label>

            <div
              style="
                display: flex;
                gap: 12px;
                justify-content: flex-end;
                align-items: center;
                margin-top: 12px;
              "
            >
              <button type="button" id="clearBtn" class="btn">Clear</button>
              <button id="saveBtn" class="btn btn--ok">Save Doctor</button>
            </div>
          </form>
        </div>
      </aside>
    </div>

    <script>
      const API_BASE = "/api/doctors";

      /* ------------ LOGOUT ------------ */
      document.getElementById("logoutBtn").addEventListener("click", () => {
        fetch("/auth/logout", { method: "POST", credentials: "include" }).then(
          () => {
            window.location.href = "login.html?logout=true";
          }
        );
      });

      const tbody = document.getElementById("doctorsTbody");
      const form = document.getElementById("doctorForm");
      const editingId = document.getElementById("editingId");
      const doctorName = document.getElementById("doctorName");
      const specialization = document.getElementById("specialization");
      const qualification = document.getElementById("qualification");
      const gender = document.getElementById("gender");
      const experience = document.getElementById("experience");
      const phoneNumber = document.getElementById("phoneNumber");
      const email = document.getElementById("email");
      const address = document.getElementById("address");
      const status = document.getElementById("status");
      const clearBtn = document.getElementById("clearBtn");
      const searchBtn = document.getElementById("btnSearch");
      const searchInput = document.getElementById("searchInput");
      const filterStatus = document.getElementById("filterStatus");

      /* ------------ LOAD LIST ------------ */
      async function bootLoad() {
        try {
          const res = await fetch(API_BASE, { credentials: "include" });
          if (!res.ok) throw new Error("Failed to load doctors: " + res.status);
          const list = await res.json();
          renderList(list);
        } catch (err) {
          console.error(err);
          tbody.innerHTML =
            '<tr><td colspan="8" class="muted">Could not load doctors.</td></tr>';
        }
      }

      function renderList(list) {
        tbody.innerHTML = "";
        if (!Array.isArray(list) || list.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="8" class="muted">No doctors found.</td></tr>';
          return;
        }
        list.forEach((d) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${d.doctorName || ""}</td>
            <td>${d.specialization || ""}</td>
            <td>${d.qualification || ""}</td>
            <td>${d.experience || ""}</td>
            <td>${d.phoneNumber || ""}</td>
            <td>${d.email || ""}</td>
            <td><span class="pill ${
              d.status === "Active" ? "pill--ok" : "pill--warn"
            }">${d.status || "Inactive"}</span></td>
            <td class="actions">
              <button class="btn btn-edit" onclick='editDoctor(${JSON.stringify(
                d
              )})'>Edit</button>
              <button class="btn btn-delete" onclick="deleteDoctor(${
                d.id
              })">Delete</button>
            </td>`;
          tbody.appendChild(tr);
        });
      }

      /* ------------ CLEAR FORM ------------ */
      function clearForm() {
        form.reset();
        editingId.value = "";
      }
      clearBtn.addEventListener("click", clearForm);

      /* ------------ EDIT ------------ */
      function editDoctor(d) {
        editingId.value = d.id || "";
        doctorName.value = d.doctorName || "";
        specialization.value = d.specialization || "";
        qualification.value = d.qualification || "";
        gender.value = d.gender || "";
        experience.value = d.experience || "";
        phoneNumber.value = d.phoneNumber || "";
        email.value = d.email || "";
        address.value = d.address || "";
        status.value = d.status || "Active";
        window.scrollTo({ top: form.offsetTop - 20, behavior: "smooth" });
      }

      /* ------------ DELETE ------------ */
      async function deleteDoctor(id) {
        if (!confirm("Delete this doctor?")) return;
        try {
          const res = await fetch(`${API_BASE}/${id}`, {
            method: "DELETE",
            credentials: "include", // ✅ sends session cookie
          });
          if (!res.ok) throw new Error("Failed to delete: " + res.status);
          await bootLoad();
        } catch (err) {
          console.error(err);
          alert("Delete failed.");
        }
      }

      /* ------------ SAVE / UPDATE ------------ */
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = editingId.value || null;
        const payload = {
          doctorName: doctorName.value.trim(),
          specialization: specialization.value.trim(),
          qualification: qualification.value.trim(),
          gender: gender.value,
          experience: experience.value.trim(),
          phoneNumber: phoneNumber.value.trim(),
          email: email.value.trim(),
          address: address.value.trim(),
          status: status.value,
        };
        const method = id ? "PUT" : "POST";
        const url = id ? `${API_BASE}/${id}` : API_BASE;

        try {
          const res = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
            credentials: "include", // ✅ keeps session
          });
          if (!res.ok) {
            console.error("Save failed:", res.status, await res.text());
            alert("Save failed (" + res.status + ")");
            return;
          }
          clearForm();
          await bootLoad();
        } catch (err) {
          console.error("Save failed:", err);
          alert("Network error while saving.");
        }
      });

      /* ------------ SEARCH ------------ */
      searchBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        const q = searchInput.value.trim().toLowerCase();
        const statusFilter = filterStatus.value.trim().toLowerCase();
        try {
          const res = await fetch(API_BASE, { credentials: "include" });
          const list = await res.json();
          let filtered = list;
          if (q)
            filtered = filtered.filter(
              (d) =>
                (d.doctorName || "").toLowerCase().includes(q) ||
                (d.specialization || "").toLowerCase().includes(q)
            );
          if (statusFilter)
            filtered = filtered.filter(
              (d) => (d.status || "").toLowerCase() === statusFilter
            );
          renderList(filtered);
        } catch (err) {
          console.error(err);
        }
      });

      bootLoad();
    </script>
  </body>
</html>
