<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Appointments | Hospital Management System</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container">
      <h1>Appointment Management</h1>

      <!-- Appointment Form -->
      <section class="card">
        <h2>Book Appointment</h2>
        <form id="appointmentForm">
          <label for="patientId">Select Patient:</label>
          <select id="patientId" required>
            <option value="">Loading...</option>
          </select>

          <label for="doctorId">Select Doctor:</label>
          <select id="doctorId" required>
            <option value="">Loading...</option>
          </select>

          <label for="appointmentDate">Appointment Date & Time:</label>
          <input type="datetime-local" id="appointmentDate" required />

          <label for="notes">Notes:</label>
          <textarea
            id="notes"
            placeholder="Enter reason for visit..."
            rows="3"
          ></textarea>

          <button type="submit" class="btn btn--ok">Book Appointment</button>
        </form>
      </section>

      <!-- Appointments List -->
      <section class="card">
        <h2>All Appointments</h2>
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Patient</th>
              <th>Doctor</th>
              <th>Date</th>
              <th>Status</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="appointmentTableBody">
            <!-- Data loads here -->
          </tbody>
        </table>
      </section>
    </div>

    <script>
      const API_BASE = "http://localhost:8080/api";
      const tableBody = document.getElementById("appointmentTableBody");
      const patientSelect = document.getElementById("patientId");
      const doctorSelect = document.getElementById("doctorId");

      // Load all appointments
      async function loadAppointments() {
        const res = await fetch(`${API_BASE}/appointments`);
        const data = await res.json();
        tableBody.innerHTML = "";
        data.forEach((a) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
          <td>${a.appointmentId}</td>
          <td>${a.patientName}</td>
          <td>${a.doctorName}</td>
          <td>${
            a.appointmentDate ? a.appointmentDate.replace("T", " ") : ""
          }</td>
          <td>${a.status}</td>
          <td>${a.notes || ""}</td>
          <td>
            <button class="btn btn--ok" onclick="updateStatus(${
              a.appointmentId
            }, 'Completed')">Complete</button>
            <button class="btn btn--warn" onclick="updateStatus(${
              a.appointmentId
            }, 'Cancelled')">Cancel</button>
            <button class="btn btn--danger" onclick="deleteAppointment(${
              a.appointmentId
            })">Delete</button>
          </td>
        `;
          tableBody.appendChild(tr);
        });
      }

      // Load doctor & patient dropdowns
      async function loadDoctors() {
        const res = await fetch(`${API_BASE}/doctors`);
        const doctors = await res.json();
        doctorSelect.innerHTML = '<option value="">Select Doctor</option>';
        doctors.forEach((d) => {
          const opt = document.createElement("option");
          opt.value = d.id;
          opt.textContent = d.doctorName;
          doctorSelect.appendChild(opt);
        });
      }

      async function loadPatients() {
        const res = await fetch(`${API_BASE}/patients`);
        const patients = await res.json();
        patientSelect.innerHTML = '<option value="">Select Patient</option>';
        patients.forEach((p) => {
          const opt = document.createElement("option");
          opt.value = p.patientId;
          opt.textContent = p.name;
          patientSelect.appendChild(opt);
        });
      }

      // Book appointment
      document
        .getElementById("appointmentForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const body = {
            patientId: parseInt(patientSelect.value),
            doctorId: parseInt(doctorSelect.value),
            appointmentDate: document.getElementById("appointmentDate").value,
            notes: document.getElementById("notes").value,
          };

          const res = await fetch(`${API_BASE}/appointments`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });

          if (res.ok) {
            alert("Appointment booked successfully!");
            document.getElementById("appointmentForm").reset();
            loadAppointments();
          } else {
            alert("Failed to book appointment.");
          }
        });

      // Update status
      async function updateStatus(id, status) {
        const res = await fetch(`${API_BASE}/appointments/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status }),
        });
        if (res.ok) {
          alert("Status updated!");
          loadAppointments();
        }
      }

      // Delete appointment
      async function deleteAppointment(id) {
        if (!confirm("Are you sure you want to delete this appointment?"))
          return;
        const res = await fetch(`${API_BASE}/appointments/${id}`, {
          method: "DELETE",
        });
        if (res.ok) {
          alert("Appointment deleted!");
          loadAppointments();
        }
      }

      // Initial load
      window.onload = () => {
        loadDoctors();
        loadPatients();
        loadAppointments();
      };
    </script>
  </body>
</html>
