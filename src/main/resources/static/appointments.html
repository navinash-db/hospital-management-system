<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Appointments ‚Äî Hospital Management System</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      /* üîΩ Collapsible Filter Styling */
      .filter-toggle {
        display: none;
        align-items: center;
        gap: 6px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0.01)
        );
        border: 1px solid rgba(255, 255, 255, 0.06);
        padding: 8px 12px;
        border-radius: 10px;
        color: var(--text);
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 10px;
        transition: background 0.2s ease;
      }

      .filter-toggle:hover {
        background: rgba(255, 255, 255, 0.04);
      }

      .filter-arrow {
        display: inline-block;
        transition: transform 0.25s ease;
      }

      .filter-arrow.rotated {
        transform: rotate(180deg);
      }

      .filter-panel {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      @media (max-width: 768px) {
        .filter-toggle {
          display: flex;
        }

        .filter-panel {
          display: none;
          margin-top: 8px;
          padding-top: 8px;
          border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .filter-panel.active {
          display: flex;
        }
      }
    </style>
  </head>

  <body class="appointments">
    <div class="container">
      <!-- Header -->
      <header class="header">
        <h1 class="title">Appointment Management</h1>
        <div style="display: flex; gap: 10px">
          <a class="btn" href="patients.html">Patients</a>
          <a class="btn" href="billing.html">Billing</a>
          <button class="btn" id="logoutBtn">Logout</button>
        </div>
      </header>

      <div class="grid">
        <!-- Appointment List -->
        <section class="card">
          <div class="card__header">
            <h2 class="card__title">All Appointments</h2>

            <!-- Toggle Button (visible only on small screens) -->
            <button id="toggleFilter" class="filter-toggle">
              üîç Filter Appointments
              <span id="filterArrow" class="filter-arrow">‚ñº</span>
            </button>

            <!-- Filter Controls -->
            <div id="filterPanel" class="search filter-panel">
              <input
                id="searchInput"
                class="input"
                placeholder="Search by patient or doctor"
              />
              <input id="filterDate" class="input" type="date" />
              <select id="filterStatus" class="select">
                <option value="">Status</option>
                <option value="Booked">Booked</option>
                <option value="Completed">Completed</option>
                <option value="Cancelled">Cancelled</option>
              </select>
              <button id="filterBtn" class="btn">Filter</button>
              <button id="resetBtn" class="btn">Reset</button>
            </div>
          </div>

          <!-- Table -->
          <div class="card__body table-wrap">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Patient</th>
                  <th>Doctor</th>
                  <th>Date</th>
                  <th>Status</th>
                  <th>Notes</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="appointmentTableBody">
                <!-- Data loads here -->
              </tbody>
            </table>
          </div>

          <p class="muted" style="padding: 0 22px 20px">
            Loaded from <code>GET /api/appointments</code>.
          </p>
        </section>

        <!-- Appointment Form -->
        <aside class="card">
          <div class="card__header">
            <h2 class="card__title">Book Appointment</h2>
          </div>

          <div class="card__body">
            <form id="appointmentForm" class="grid">
              <div>
                <label class="label" for="patientId">Select Patient</label>
                <select id="patientId" class="select" required>
                  <option value="">Loading...</option>
                </select>
              </div>

              <div>
                <label class="label" for="doctorId">Select Doctor</label>
                <select id="doctorId" class="select" required>
                  <option value="">Loading...</option>
                </select>
              </div>

              <div>
                <label class="label" for="appointmentDate"
                  >Appointment Date & Time</label
                >
                <input
                  type="datetime-local"
                  id="appointmentDate"
                  class="input"
                  required
                />
              </div>

              <div>
                <label class="label" for="notes">Notes</label>
                <textarea
                  id="notes"
                  class="textarea"
                  placeholder="Enter reason for visit..."
                  rows="3"
                ></textarea>
              </div>

              <div
                style="
                  display: flex;
                  gap: 10px;
                  justify-content: flex-end;
                  flex-wrap: wrap;
                "
              >
                <button type="reset" class="btn">Clear</button>
                <button type="submit" class="btn btn--ok">
                  Book Appointment
                </button>
              </div>
            </form>

            <p class="muted" style="margin-top: 18px">
              Submitted to <code>POST /api/appointments</code>.
            </p>
          </div>
        </aside>
      </div>
    </div>

    <script>
      /* ---------------- Secure Appointment Management ---------------- */

      const API_BASE = "/api";

      // ‚úÖ Logout
      document.getElementById("logoutBtn").addEventListener("click", () => {
        fetch("/auth/logout", { method: "POST", credentials: "include" }).then(
          () => {
            window.location.href = "login.html?logout=true";
          }
        );
      });

      const tableBody = document.getElementById("appointmentTableBody");
      const patientSelect = document.getElementById("patientId");
      const doctorSelect = document.getElementById("doctorId");
      const toggleFilter = document.getElementById("toggleFilter");
      const filterPanel = document.getElementById("filterPanel");
      const filterArrow = document.getElementById("filterArrow");

      let appointmentsList = [];

      // üîΩ Toggle filter panel (mobile)
      toggleFilter.addEventListener("click", () => {
        filterPanel.classList.toggle("active");
        filterArrow.classList.toggle("rotated");
      });

      // ‚úÖ Load appointments
      async function loadAppointments() {
        try {
          const res = await fetch(`${API_BASE}/appointments`, {
            credentials: "include",
          });
          if (!res.ok) throw new Error("Failed to load appointments");
          const data = await res.json();
          appointmentsList = data;
          renderAppointments(data);
        } catch (err) {
          console.error(err);
          tableBody.innerHTML =
            '<tr><td colspan="7" class="muted">Failed to load appointments.</td></tr>';
        }
      }

      // ‚úÖ Render table rows
      function renderAppointments(list) {
        tableBody.innerHTML = "";
        if (!list || list.length === 0) {
          tableBody.innerHTML =
            '<tr><td colspan="7" class="muted">No appointments found.</td></tr>';
          return;
        }

        list.forEach((a) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
        <td>${a.appointmentId}</td>
        <td>${a.patientName}</td>
        <td>${a.doctorName}</td>
        <td>${a.appointmentDate ? a.appointmentDate.replace("T", " ") : ""}</td>
        <td><span class="pill ${
          a.status === "Completed"
            ? "pill--ok"
            : a.status === "Cancelled"
            ? "pill--warn"
            : ""
        }">${a.status}</span></td>
        <td>${a.notes || ""}</td>
        <td class="actions">
          <button class="btn btn--ok" onclick="updateStatus(${
            a.appointmentId
          }, 'Completed')">Complete</button>
          <button class="btn btn--warn" onclick="updateStatus(${
            a.appointmentId
          }, 'Cancelled')">Cancel</button>
          <button class="btn btn-delete" onclick="deleteAppointment(${
            a.appointmentId
          })">Delete</button>
        </td>`;
          tableBody.appendChild(tr);
        });
      }

      // ‚úÖ Load doctor & patient dropdowns
      async function loadDoctors() {
        try {
          const res = await fetch(`${API_BASE}/doctors`, {
            credentials: "include",
          });
          const doctors = await res.json();
          doctorSelect.innerHTML = '<option value="">Select Doctor</option>';
          doctors.forEach((d) => {
            const opt = document.createElement("option");
            opt.value = d.id;
            opt.textContent = d.doctorName;
            doctorSelect.appendChild(opt);
          });
        } catch (err) {
          console.error("Failed to load doctors:", err);
        }
      }

      async function loadPatients() {
        try {
          const res = await fetch(`${API_BASE}/patients`, {
            credentials: "include",
          });
          const patients = await res.json();
          patientSelect.innerHTML = '<option value="">Select Patient</option>';
          patients.forEach((p) => {
            const opt = document.createElement("option");
            opt.value = p.patientId;
            opt.textContent = p.name;
            patientSelect.appendChild(opt);
          });
        } catch (err) {
          console.error("Failed to load patients:", err);
        }
      }

      // ‚úÖ Book new appointment
      document
        .getElementById("appointmentForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const body = {
            patientId: parseInt(patientSelect.value),
            doctorId: parseInt(doctorSelect.value),
            appointmentDate: document.getElementById("appointmentDate").value,
            notes: document.getElementById("notes").value,
          };

          try {
            const res = await fetch(`${API_BASE}/appointments`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(body),
              credentials: "include",
            });

            if (res.ok) {
              alert("Appointment booked successfully!");
              e.target.reset();
              loadAppointments();
            } else {
              alert("Failed to book appointment (" + res.status + ")");
            }
          } catch (err) {
            console.error("Book error:", err);
          }
        });

      // ‚úÖ Update status
      async function updateStatus(id, status) {
        try {
          const res = await fetch(`${API_BASE}/appointments/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status }),
            credentials: "include",
          });
          if (res.ok) {
            alert("Status updated!");
            loadAppointments();
          } else {
            alert("Update failed (" + res.status + ")");
          }
        } catch (err) {
          console.error("Update error:", err);
        }
      }

      // ‚úÖ Delete appointment
      async function deleteAppointment(id) {
        if (!confirm("Are you sure you want to delete this appointment?"))
          return;
        try {
          const res = await fetch(`${API_BASE}/appointments/${id}`, {
            method: "DELETE",
            credentials: "include",
          });
          if (res.ok) {
            alert("Appointment deleted!");
            loadAppointments();
          } else {
            alert("Delete failed (" + res.status + ")");
          }
        } catch (err) {
          console.error("Delete error:", err);
        }
      }

      // ‚úÖ Filtering (client-side)
      document.getElementById("filterBtn").addEventListener("click", () => {
        const searchVal = document
          .getElementById("searchInput")
          .value.toLowerCase()
          .trim();
        const dateVal = document.getElementById("filterDate").value;
        const statusVal = document.getElementById("filterStatus").value;

        let filtered = appointmentsList;

        if (searchVal)
          filtered = filtered.filter(
            (a) =>
              a.patientName.toLowerCase().includes(searchVal) ||
              a.doctorName.toLowerCase().includes(searchVal)
          );

        if (dateVal)
          filtered = filtered.filter((a) =>
            a.appointmentDate.startsWith(dateVal)
          );

        if (statusVal)
          filtered = filtered.filter(
            (a) =>
              a.status && a.status.toLowerCase() === statusVal.toLowerCase()
          );

        renderAppointments(filtered);
      });

      document.getElementById("resetBtn").addEventListener("click", () => {
        document.getElementById("searchInput").value = "";
        document.getElementById("filterDate").value = "";
        document.getElementById("filterStatus").value = "";
        renderAppointments(appointmentsList);
      });

      // ‚úÖ Initial load
      window.onload = () => {
        loadDoctors();
        loadPatients();
        loadAppointments();
      };
    </script>
  </body>
</html>
