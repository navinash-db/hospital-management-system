<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login — Hospital Management System</title>
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body
    style="
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: var(--bg);
    "
  >
    <div class="card" style="width: 360px; padding: 30px; text-align: center">
      <h2 class="card__title">Hospital Login</h2>

      <!-- Login Form -->
      <form id="loginForm" style="margin-top: 20px">
        <div style="margin-bottom: 15px; text-align: left">
          <label class="label" for="username">Username</label>
          <input class="input" id="username" name="username" required />
        </div>

        <div style="margin-bottom: 15px; text-align: left">
          <label class="label" for="password">Password</label>
          <input
            class="input"
            id="password"
            name="password"
            type="password"
            required
          />
        </div>

        <button type="submit" class="btn btn--ok" style="width: 100%">
          Login
        </button>
      </form>

      <!-- Error message -->
      <p
        id="errorMsg"
        class="muted"
        style="color: #f87171; margin-top: 14px; display: none"
      >
        Invalid username or password.
      </p>
    </div>

    <script>
      // ✅ Point to your backend login endpoint
      const API_URL = "/auth/login";

      document
        .getElementById("loginForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const username = document.getElementById("username").value.trim();
          const password = document.getElementById("password").value.trim();
          const errorMsg = document.getElementById("errorMsg");
          errorMsg.style.display = "none";

          // Prepare form data for Spring form-based login
          const formData = new URLSearchParams();
          formData.append("username", username);
          formData.append("password", password);

          try {
            // Use fetch to send credentials to Spring Security's login endpoint
            const res = await fetch(API_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: formData.toString(),
            });

            console.log("Response status:", res.status);

            // If Spring redirects (302), follow the redirect manually
            if (res.redirected) {
              window.location.href = res.url;
              return;
            }

            // Handle wrong credentials or unexpected responses
            if (!res.ok) {
              errorMsg.textContent = "Invalid username or password.";
              errorMsg.style.display = "block";
              return;
            }

            // Success → manually get current user role (optional)
            const userResponse = await fetch("/auth/me");
            if (userResponse.ok) {
              const user = await userResponse.json();
              console.log("User info:", user);

              if (user.role === "ADMIN") {
                window.location.href = "doctors.html";
              } else if (user.role === "RECEPTIONIST") {
                window.location.href = "patients.html";
              } else {
                errorMsg.textContent = "Unknown role. Contact admin.";
                errorMsg.style.display = "block";
              }
            } else {
              // Fallback redirect if /auth/me not implemented
              window.location.href = "doctors.html";
            }
          } catch (err) {
            console.error("Login error:", err);
            errorMsg.textContent = "Network error. Try again.";
            errorMsg.style.display = "block";
          }
        });
    </script>
  </body>
</html>
