<!DOCTYPE html>
<html lang="en" class="billing">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Billing Management ‚Äì Hospital Management</title>
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body class="billing">
    <div class="container">
      <!-- Header -->
      <header class="header">
        <h1 class="title">Billing Management</h1>
        <a class="home-btn" href="index.html">Home</a>
      </header>

      <div class="grid">
        <!-- Billing Records Table -->
        <section class="card">
          <div class="card__header">
            <h2 class="card__title">Billing Records</h2>
            <button id="refreshBtn" class="btn btn--ok">Refresh</button>
          </div>

          <div class="card__body table-wrap">
            <table id="billingTable" aria-label="Billing Table">
              <thead>
                <tr>
                  <th>Bill ID</th>
                  <th>Patient</th>
                  <th>Phone</th>
                  <th>Consultation</th>
                  <th>Medicine</th>
                  <th>Lab</th>
                  <th>Total</th>
                  <th>Status</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="billingTbody">
                <!-- dynamically filled -->
              </tbody>
            </table>
          </div>
        </section>

        <!-- Create Bill Form -->
        <aside class="card">
          <div class="card__header">
            <h2 class="card__title">Create Bill</h2>
          </div>

          <div class="card__body">
            <form id="billingForm" class="grid">
              <!-- Patient -->
              <div>
                <label class="label" for="patientSelect">Patient</label>
                <select id="patientSelect" class="select" required>
                  <option value="">Select patient</option>
                </select>
              </div>

              <!-- Appointment ID -->
              <div>
                <label class="label" for="appointmentId">Appointment ID</label>
                <input
                  id="appointmentId"
                  type="number"
                  class="input"
                  placeholder="Optional"
                />
              </div>

              <!-- Charges -->
              <div class="two-col">
                <label class="label">
                  Consultation Fee
                  <input id="consultationFee" type="number" class="input" />
                </label>
                <label class="label">
                  Medicine Charges
                  <input id="medicineCharges" type="number" class="input" />
                </label>
              </div>

              <label class="label">
                Lab Charges
                <input id="labCharges" type="number" class="input" />
              </label>

              <!-- Payment -->
              <label class="label">
                Payment Status
                <select id="paymentStatus" class="select">
                  <option value="Paid">Paid</option>
                  <option value="Pending">Pending</option>
                  <option value="Cancelled">Cancelled</option>
                </select>
              </label>

              <!-- Buttons -->
              <div
                style="
                  display: flex;
                  gap: 10px;
                  flex-wrap: wrap;
                  justify-content: flex-end;
                "
              >
                <button class="btn" type="reset">Clear</button>
                <button class="btn btn--ok" type="submit">Create Bill</button>
              </div>
            </form>
          </div>
        </aside>
      </div>
    </div>

    <script>
      const API_BASE_BILLING = "/api/billings";
      const API_BASE_PATIENTS = "/api/patients";

      const patientSelect = document.getElementById("patientSelect");
      const billingTbody = document.getElementById("billingTbody");
      const refreshBtn = document.getElementById("refreshBtn");
      const billingForm = document.getElementById("billingForm");

      // üßæ Load all patients for dropdown
      async function loadPatients() {
        try {
          const res = await fetch(API_BASE_PATIENTS);
          if (!res.ok) throw new Error("Failed to load patients");
          const patients = await res.json();

          patientSelect.innerHTML = '<option value="">Select patient</option>';
          patients.forEach((p) => {
            const option = document.createElement("option");
            option.value = `${p.name}|${p.phoneNumber}`; // store both
            option.textContent = `${p.name} (${p.phoneNumber})`;
            patientSelect.appendChild(option);
          });
        } catch (err) {
          console.error("Error loading patients:", err);
        }
      }

      // üí≥ Load all billing records
      async function loadBillingRecords() {
        try {
          const res = await fetch(API_BASE_BILLING);
          if (!res.ok) throw new Error("Failed to load bills");
          const list = await res.json();

          billingTbody.innerHTML = "";
          if (!Array.isArray(list) || list.length === 0) {
            billingTbody.innerHTML =
              '<tr><td colspan="10" class="muted">No billing records found.</td></tr>';
            return;
          }

          list.forEach((b) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${b.billId}</td>
              <td>${b.patientName || "‚Äî"}</td>
              <td>${b.patientPhone || "‚Äî"}</td>
              <td>${b.consultationFee || 0}</td>
              <td>${b.medicineCharges || 0}</td>
              <td>${b.labCharges || 0}</td>
              <td>${b.totalAmount || 0}</td>
              <td><span class="pill ${
                b.paymentStatus === "Paid" ? "pill--ok" : "pill--warn"
              }">${b.paymentStatus}</span></td>
              <td>${b.billingDate?.split("T")[0]}</td>
              <td class="actions">
                <button class="btn btn-delete" onclick="deleteBill(${
                  b.billId
                })">Delete</button>
              </td>
            `;
            billingTbody.appendChild(tr);
          });
        } catch (err) {
          console.error("Error loading bills:", err);
        }
      }

      // üßæ Submit billing form
      billingForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const [patientName, patientPhone] = patientSelect.value.split("|");

        const payload = {
          patientName,
          patientPhone,
          appointmentId: document.getElementById("appointmentId").value || null,
          consultationFee:
            parseFloat(document.getElementById("consultationFee").value) || 0,
          medicineCharges:
            parseFloat(document.getElementById("medicineCharges").value) || 0,
          labCharges:
            parseFloat(document.getElementById("labCharges").value) || 0,
          paymentStatus: document.getElementById("paymentStatus").value,
        };

        try {
          const res = await fetch(API_BASE_BILLING, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            const text = await res.text();
            alert("Failed to create bill: " + text);
            return;
          }

          billingForm.reset();
          await loadBillingRecords();
        } catch (err) {
          console.error("Create bill error:", err);
          alert("Error creating bill");
        }
      });

      // ‚ùå Delete bill
      async function deleteBill(id) {
        if (!confirm("Are you sure you want to delete this bill?")) return;
        try {
          const res = await fetch(`${API_BASE_BILLING}/${id}`, {
            method: "DELETE",
          });
          if (!res.ok) throw new Error("Failed to delete bill");
          await loadBillingRecords();
        } catch (err) {
          console.error(err);
        }
      }

      // üîÑ Refresh
      refreshBtn.addEventListener("click", loadBillingRecords);

      // üöÄ On page load
      loadPatients();
      loadBillingRecords();
    </script>
  </body>
</html>
