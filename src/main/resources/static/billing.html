<!DOCTYPE html>
<html lang="en" class="billing">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Billing Management – Hospital Management</title>
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body class="billing">
    <div class="container">
      <!-- Page Header -->
      <header class="header">
        <h1 class="title">Billing Management</h1>
        <a class="btn" href="index.html">Home</a>
      </header>

      <div class="grid">
        <!-- Billing List -->
        <section class="card">
          <div class="card__header">
            <h2 class="card__title">Billing Records</h2>

            <!-- Search -->
            <form class="search" id="searchForm">
              <input
                class="input"
                id="searchInput"
                placeholder="Search by patient name or phone"
              />
              <select class="select" id="filterPayment">
                <option value="">Payment Status</option>
                <option value="Paid">Paid</option>
                <option value="Pending">Pending</option>
                <option value="Cancelled">Cancelled</option>
              </select>
              <button class="btn" type="submit">Filter</button>
            </form>
          </div>

          <div class="card__body table-wrap">
            <table aria-label="Billing table">
              <colgroup>
                <col class="pt-name" />
                <col class="pt-phone" />
                <col class="pt-age" />
                <col class="pt-gender" />
                <col class="pt-email" />
                <col class="pt-status" />
                <col class="pt-actions" />
              </colgroup>

              <thead>
                <tr>
                  <th>Patient Name</th>
                  <th>Phone</th>
                  <th>Total Amount (₹)</th>
                  <th>Consultation</th>
                  <th>Lab + Medicine</th>
                  <th>Payment</th>
                  <th>Actions</th>
                </tr>
              </thead>

              <tbody id="billingTbody">
                <!-- Populated by JS -->
              </tbody>
            </table>
          </div>

          <div class="card__body">
            <p class="note">Loaded from <code>GET /api/billings</code>.</p>
          </div>
        </section>

        <!-- Billing Form -->
        <aside class="card">
          <div class="card__header">
            <h2 class="card__title">Create Bill</h2>
          </div>

          <div class="card__body">
            <form class="grid" id="billingForm">
              <!-- Patient Info -->
              <div class="two-col">
                <div>
                  <label class="label">Patient Name</label>
                  <input
                    id="patientName"
                    class="input"
                    placeholder="Enter patient name"
                    required
                  />
                </div>
                <div>
                  <label class="label">Phone Number</label>
                  <input
                    id="patientPhone"
                    class="input"
                    placeholder="Enter phone number"
                    required
                  />
                </div>
              </div>

              <!-- Charges -->
              <div class="two-col">
                <div>
                  <label class="label">Consultation Fee (₹)</label>
                  <input
                    id="consultationFee"
                    class="input"
                    type="number"
                    min="0"
                    step="0.01"
                  />
                </div>
                <div>
                  <label class="label">Medicine Charges (₹)</label>
                  <input
                    id="medicineCharges"
                    class="input"
                    type="number"
                    min="0"
                    step="0.01"
                  />
                </div>
              </div>

              <div class="two-col">
                <div>
                  <label class="label">Lab Charges (₹)</label>
                  <input
                    id="labCharges"
                    class="input"
                    type="number"
                    min="0"
                    step="0.01"
                  />
                </div>
                <div>
                  <label class="label">Payment Status</label>
                  <select id="paymentStatus" class="select" required>
                    <option value="">Select</option>
                    <option value="Paid">Paid</option>
                    <option value="Pending">Pending</option>
                    <option value="Cancelled">Cancelled</option>
                  </select>
                </div>
              </div>

              <!-- Form Buttons -->
              <div
                style="
                  display: flex;
                  gap: 12px;
                  justify-content: flex-end;
                  flex-wrap: wrap;
                  margin-top: 14px;
                "
              >
                <button type="reset" class="btn">Clear</button>
                <button type="submit" class="btn btn--ok">Save Bill</button>
              </div>
            </form>
          </div>
        </aside>
      </div>
    </div>

    <script>
      const API_BASE = "/api/billings";
      const tbody = document.getElementById("billingTbody");
      const form = document.getElementById("billingForm");

      async function loadBillings() {
        try {
          const res = await fetch(API_BASE);
          if (!res.ok) throw new Error("Failed to fetch");
          const list = await res.json();
          renderTable(list);
        } catch (err) {
          console.error(err);
          tbody.innerHTML =
            '<tr><td colspan="7" class="muted">Could not load billing data.</td></tr>';
        }
      }

      function renderTable(list) {
        tbody.innerHTML = "";
        if (!list || list.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="7" class="muted">No billing records found.</td></tr>';
          return;
        }

        list.forEach((b) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${b.patientName || "-"}</td>
            <td>${b.patientPhone || "-"}</td>
            <td>${b.totalAmount || 0}</td>
            <td>${b.consultationFee || 0}</td>
            <td>${(b.labCharges || 0) + (b.medicineCharges || 0)}</td>
            <td>
              <span class="pill ${
                b.paymentStatus === "Paid"
                  ? "pill--ok"
                  : b.paymentStatus === "Pending"
                  ? "pill--warn"
                  : "pill--danger"
              }">${b.paymentStatus || "Unknown"}</span>
            </td>
            <td class="actions">
              <button class="btn btn-delete" onclick="deleteBill(${
                b.billId
              })">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      async function deleteBill(id) {
        if (!confirm("Delete this billing record?")) return;
        try {
          const res = await fetch(`${API_BASE}/${id}`, { method: "DELETE" });
          if (!res.ok) throw new Error("Delete failed");
          loadBillings();
        } catch (err) {
          alert("Delete failed.");
        }
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const dto = {
          patientName: document.getElementById("patientName").value.trim(),
          patientPhone: document.getElementById("patientPhone").value.trim(),
          consultationFee:
            parseFloat(document.getElementById("consultationFee").value) || 0,
          medicineCharges:
            parseFloat(document.getElementById("medicineCharges").value) || 0,
          labCharges:
            parseFloat(document.getElementById("labCharges").value) || 0,
          paymentStatus: document.getElementById("paymentStatus").value,
        };

        try {
          const res = await fetch(API_BASE, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dto),
          });
          if (!res.ok) {
            const body = await res.json().catch(() => ({}));
            alert("Failed to save bill: " + (body.error || res.statusText));
            return;
          }
          form.reset();
          loadBillings();
        } catch (err) {
          console.error(err);
          alert("Network error while saving bill.");
        }
      });

      document.getElementById("searchForm").addEventListener("submit", (e) => {
        e.preventDefault();
        doFilter();
      });

      async function doFilter() {
        const q = document
          .getElementById("searchInput")
          .value.trim()
          .toLowerCase();
        const status = document.getElementById("filterPayment").value.trim();
        const res = await fetch(API_BASE);
        const list = await res.json();

        const filtered = list.filter((b) => {
          const matchName =
            b.patientName?.toLowerCase().includes(q) ||
            b.patientPhone?.includes(q);
          const matchStatus = status
            ? (b.paymentStatus || "").toLowerCase() === status.toLowerCase()
            : true;
          return matchName && matchStatus;
        });
        renderTable(filtered);
      }

      loadBillings();
    </script>
  </body>
</html>
