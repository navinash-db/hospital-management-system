<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Patients — Hospital Management</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body class="patients">
    <div class="container">
      <header class="header">
        <h1 class="title">Patient Management</h1>
        <a class="home-btn" href="login.html" onclick="logout()">Logout</a>
      </header>

      <!-- Directory card -->
      <section class="card">
        <div class="card__header">
          <h2 class="card__title">Directory</h2>

          <div class="search">
            <input
              id="searchInput"
              class="input"
              placeholder="Search by name or phone"
            />
            <select id="filterStatus" class="select">
              <option value="">Status</option>
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
            </select>
            <button id="btnSearch" class="btn">Search</button>
          </div>
        </div>

        <div class="card__body">
          <div class="table-wrap">
            <table id="patientsTable">
              <colgroup>
                <col class="pt-name" />
                <col class="pt-age" />
                <col class="pt-gender" />
                <col class="pt-phone" />
                <col class="pt-email" />
                <col class="pt-status" />
                <col class="pt-actions" />
              </colgroup>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Age</th>
                  <th>Gender</th>
                  <th>Phone</th>
                  <th>Email</th>
                  <th style="text-align: center">Status</th>
                  <th style="text-align: center">Actions</th>
                </tr>
              </thead>
              <tbody id="patientsTbody">
                <!-- populated by JS -->
              </tbody>
            </table>
          </div>

          <p class="muted">Loaded from GET <code>/api/patients</code>.</p>
        </div>
      </section>

      <!-- Add / Edit card -->
      <aside class="card">
        <div class="card__header">
          <h2 class="card__title">Add / Edit Patient</h2>
        </div>
        <div class="card__body">
          <form id="patientForm" class="grid">
            <input id="editingId" type="hidden" />

            <label class="label"
              >Full name
              <input id="fullName" class="input" required />
            </label>

            <div class="two-col">
              <label class="label"
                >Date of birth
                <input id="dob" type="date" class="input" />
              </label>
              <label class="label"
                >Gender
                <select id="gender" class="select">
                  <option value="">Select gender</option>
                  <option value="M">M</option>
                  <option value="F">F</option>
                  <option value="O">Other</option>
                </select>
              </label>
            </div>

            <div class="two-col">
              <label class="label"
                >Phone
                <input id="phone" class="input" />
              </label>
              <label class="label"
                >Email
                <input id="email" class="input" type="email" />
              </label>
            </div>

            <label class="label"
              >Address
              <textarea
                id="address"
                class="textarea"
                placeholder="Street, city, pin..."
              ></textarea>
            </label>

            <label class="label"
              >Notes
              <textarea
                id="notes"
                class="textarea"
                placeholder="Allergies, ongoing medications..."
              ></textarea>
            </label>

            <div
              style="
                display: flex;
                gap: 12px;
                justify-content: flex-end;
                align-items: center;
                margin-top: 12px;
              "
            >
              <button type="button" id="clearBtn" class="btn">Clear</button>
              <button id="saveBtn" class="btn btn--ok">Save Patient</button>
            </div>
          </form>
        </div>
      </aside>
    </div>

    <!-- View modal -->
    <div id="viewModal" class="modal" aria-hidden="true" style="display: none">
      <div class="modal__dialog">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <h3 id="modalName" style="margin: 0">Notes</h3>
          <button id="modalClose" class="btn">Close</button>
        </div>
        <div id="modalNotes" class="modal-body" style="margin-top: 12px">—</div>
      </div>
    </div>

    <script>
      const API_BASE = "/api/patients";

      const tbody = document.getElementById("patientsTbody");
      const form = document.getElementById("patientForm");
      const editingId = document.getElementById("editingId");
      const fullName = document.getElementById("fullName");
      const dob = document.getElementById("dob");
      const gender = document.getElementById("gender");
      const phone = document.getElementById("phone");
      const email = document.getElementById("email");
      const address = document.getElementById("address");
      const notes = document.getElementById("notes");
      const clearBtn = document.getElementById("clearBtn");
      const searchBtn = document.getElementById("btnSearch");
      const searchInput = document.getElementById("searchInput");
      const filterStatus = document.getElementById("filterStatus");

      const viewModal = document.getElementById("viewModal");
      const modalClose = document.getElementById("modalClose");
      const modalName = document.getElementById("modalName");
      const modalNotes = document.getElementById("modalNotes");

      // ---- Utility helpers ----
      function computeAgeFromDob(dobVal) {
        if (!dobVal) return null;
        const birth = new Date(dobVal);
        if (isNaN(birth)) return null;
        const now = new Date();
        let age = now.getFullYear() - birth.getFullYear();
        const m = now.getMonth() - birth.getMonth();
        if (m < 0 || (m === 0 && now.getDate() < birth.getDate())) age--;
        return age;
      }

      async function bootLoad() {
        try {
          const res = await fetch(API_BASE, { credentials: "include" });
          if (!res.ok) throw new Error("Failed to load patients");
          const list = await res.json();
          renderList(list);
        } catch (err) {
          console.error(err);
          tbody.innerHTML =
            '<tr><td colspan="7" class="muted">Could not load patients.</td></tr>';
        }
      }

      function renderList(list) {
        tbody.innerHTML = "";
        if (!Array.isArray(list) || list.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="7" class="muted">No patients found.</td></tr>';
          return;
        }

        list.forEach((p) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${p.name || ""}</td>
            <td>${p.age ?? ""}</td>
            <td>${p.gender || ""}</td>
            <td>${p.phoneNumber || ""}</td>
            <td>${p.email || "—"}</td>
            <td><span class="pill ${
              p.status === "Active" ? "pill--ok" : "pill--warn"
            }">${p.status || "Unknown"}</span></td>
            <td class="actions">
              <button class="btn btn-view" onclick='openView(${JSON.stringify(
                p
              )})'>View</button>
              <button class="btn btn-edit" onclick='populateForm(${JSON.stringify(
                p
              )})'>Edit</button>
              <button class="btn btn-delete" onclick='confirmDelete(${
                p.patientId
              })'>Delete</button>
            </td>`;
          tbody.appendChild(tr);
        });
      }

      function openView(p) {
        modalName.textContent = p.name ? p.name + " — Notes" : "Notes";
        modalNotes.textContent = p.notes || "(no notes)";
        viewModal.style.display = "flex";
      }

      modalClose.addEventListener("click", () => {
        viewModal.style.display = "none";
      });

      function populateForm(p) {
        editingId.value = p.patientId || "";
        fullName.value = p.name || "";
        if (!p.dob && p.age) {
          const year = new Date().getFullYear() - Number(p.age);
          dob.value = `${year}-01-01`;
        } else {
          dob.value = p.dob || "";
        }
        gender.value = p.gender || "";
        phone.value = p.phoneNumber || "";
        email.value = p.email || "";
        address.value = p.address || "";
        notes.value = p.notes || "";
      }

      clearBtn.addEventListener("click", (e) => {
        e.preventDefault();
        form.reset();
        editingId.value = "";
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        await submitForm();
      });

      async function submitForm() {
        const id = editingId.value || null;
        const payload = {
          name: fullName.value.trim(),
          age: computeAgeFromDob(dob.value),
          gender: gender.value,
          phoneNumber: phone.value.trim(),
          email: email.value.trim(),
          address: address.value.trim(),
          notes: notes.value.trim(),
          status: "Active",
        };

        try {
          const method = id ? "PUT" : "POST";
          const url = id ? `${API_BASE}/${id}` : API_BASE;
          const res = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
            credentials: "include", // ✅ sends session cookie
          });

          if (!res.ok) {
            alert("Save failed (" + res.status + ")");
            return;
          }

          form.reset();
          editingId.value = "";
          await bootLoad();
        } catch (err) {
          console.error("Save failed:", err);
          alert("Network error while saving patient.");
        }
      }

      async function confirmDelete(id) {
        if (!confirm("Delete this patient?")) return;
        try {
          const res = await fetch(`${API_BASE}/${id}`, {
            method: "DELETE",
            credentials: "include", // ✅ ensures session is sent
          });
          if (!res.ok) {
            alert("Delete failed (" + res.status + ")");
            return;
          }
          await bootLoad();
        } catch (err) {
          console.error(err);
          alert("Delete failed (network).");
        }
      }

      searchBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        const q = searchInput.value.trim().toLowerCase();
        const status = filterStatus.value.trim().toLowerCase();
        try {
          const res = await fetch(API_BASE, { credentials: "include" });
          const list = await res.json();
          let filtered = list;
          if (q)
            filtered = filtered.filter(
              (p) =>
                (p.name || "").toLowerCase().includes(q) ||
                (p.phoneNumber || "").includes(q)
            );
          if (status)
            filtered = filtered.filter(
              (p) => (p.status || "").toLowerCase() === status
            );
          renderList(filtered);
        } catch (err) {
          console.error(err);
        }
      });

      function logout() {
        fetch("/auth/logout", { method: "POST", credentials: "include" }).then(
          () => {
            window.location.href = "login.html?logout=true";
          }
        );
      }

      bootLoad();
    </script>
  </body>
</html>
